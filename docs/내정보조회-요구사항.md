# 내 정보 조회 + JWT 인증 요구사항

## 개요
로그인 API와 JWT 인증을 구현하고, 인증된 사용자가 자신의 정보를 조회할 수 있는 API를 제공합니다.

---

## Part 1: JWT 인증 시스템

### 1.1 로그인 API

#### Endpoint
```
POST /api/v1/auth/login
```

#### Request Body
```json
{
  "loginId": "string",
  "password": "string"
}
```

#### Response (성공 - 200 OK)
```json
{
  "result": "SUCCESS",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "tokenType": "Bearer",
    "expiresIn": 3600
  },
  "error": null
}
```

#### Response (실패 - 401 Unauthorized)
```json
{
  "result": "ERROR",
  "data": null,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "아이디 또는 비밀번호가 올바르지 않습니다."
  }
}
```

### 1.2 JWT 토큰 사양

| 항목 | 값 |
|------|-----|
| Algorithm | HS256 |
| 만료 시간 | 1시간 (3600초) |
| Issuer | commerce-api |
| Subject | 회원 ID (Long) |

#### JWT Payload 구조
```json
{
  "sub": "123",
  "loginId": "user_id",
  "iat": 1709712000,
  "exp": 1709715600,
  "iss": "commerce-api"
}
```

### 1.3 구현 컴포넌트

#### 레이어별 구조

```
interfaces/api/auth/
  ├── AuthV1Controller.kt      # 로그인 컨트롤러
  ├── AuthV1ApiSpec.kt         # OpenAPI 스펙
  └── AuthV1Dto.kt             # Request/Response DTO

application/auth/
  ├── AuthFacade.kt            # 인증 퍼사드
  └── TokenInfo.kt             # 토큰 정보 DTO

domain/auth/
  ├── AuthService.kt           # 인증 서비스
  ├── JwtTokenProvider.kt      # JWT 토큰 생성/검증 인터페이스
  └── AuthenticatedMember.kt   # 인증된 회원 정보

infrastructure/auth/
  ├── JwtTokenProviderImpl.kt  # JWT 구현체 (jjwt 사용)
  └── JwtAuthenticationFilter.kt # JWT 인증 필터

support/
  └── config/
      └── JwtConfig.kt         # JWT 설정 (secret, expiration)
```

### 1.4 의존성 추가 (build.gradle.kts)

```kotlin
// JWT
implementation("io.jsonwebtoken:jjwt-api:0.12.5")
runtimeOnly("io.jsonwebtoken:jjwt-impl:0.12.5")
runtimeOnly("io.jsonwebtoken:jjwt-jackson:0.12.5")
```

### 1.5 설정 (application.yml)

```yaml
jwt:
  secret: ${JWT_SECRET:your-256-bit-secret-key-here-for-hs256-algorithm}
  expiration: 3600  # 1시간 (초)
  issuer: commerce-api
```

---

## Part 2: 내 정보 조회 API

### 2.1 Endpoint

```
GET /api/v1/members/me
Authorization: Bearer {accessToken}
```

### 2.2 Response (성공 - 200 OK)

```json
{
  "result": "SUCCESS",
  "data": {
    "loginId": "user_id",
    "name": "홍*동",
    "birthDate": "1990-01-15",
    "email": "ho***@example.com"
  },
  "error": null
}
```

### 2.3 Response (실패)

#### 인증 토큰 없음 (401 Unauthorized)
```json
{
  "result": "ERROR",
  "data": null,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "인증이 필요합니다."
  }
}
```

#### 토큰 만료 (401 Unauthorized)
```json
{
  "result": "ERROR",
  "data": null,
  "error": {
    "code": "TOKEN_EXPIRED",
    "message": "토큰이 만료되었습니다."
  }
}
```

#### 유효하지 않은 토큰 (401 Unauthorized)
```json
{
  "result": "ERROR",
  "data": null,
  "error": {
    "code": "INVALID_TOKEN",
    "message": "유효하지 않은 토큰입니다."
  }
}
```

### 2.4 마스킹 규칙

#### 이름 마스킹
- 2글자: 첫 글자 + `*` (예: `홍길` → `홍*`)
- 3글자 이상: 첫 글자 + `*` 반복 + 마지막 글자 (예: `홍길동` → `홍*동`)
- 영문도 동일 규칙 적용 (예: `John Doe` → `J******e`)

#### 이메일 마스킹
- `@` 기준으로 로컬 파트와 도메인 분리
- 로컬 파트: 앞 2글자 + `***` (예: `example@` → `ex***@`)
- 도메인은 그대로 유지
- 예: `hong@example.com` → `ho***@example.com`

### 2.5 구현 컴포넌트

```
interfaces/api/member/
  ├── MemberV1Controller.kt    # 기존 + getMyInfo 추가
  ├── MemberV1ApiSpec.kt       # 기존 + getMyInfo 스펙 추가
  └── MemberV1Dto.kt           # 기존 + MyInfoResponse 추가

application/member/
  └── MemberFacade.kt          # 기존 + getMyInfo 추가

domain/member/
  ├── MemberService.kt         # 기존 + findById 추가
  └── MemberRepository.kt      # 기존 (findById 이미 있음)

support/util/
  └── MaskingUtils.kt          # 마스킹 유틸리티
```

---

## Part 3: 구현 체크리스트

### Phase 1: JWT 인프라 구축
- [ ] JWT 의존성 추가
- [ ] JWT 설정 클래스 구현
- [ ] JwtTokenProvider 인터페이스 및 구현체
- [ ] JWT 인증 필터 구현
- [ ] 인증 예외 처리 (ErrorType 추가)

### Phase 2: 로그인 API
- [ ] AuthV1Dto (LoginRequest, LoginResponse)
- [ ] AuthService (로그인 검증)
- [ ] AuthFacade (토큰 발급 오케스트레이션)
- [ ] AuthV1Controller + ApiSpec
- [ ] 로그인 API 테스트

### Phase 3: 내 정보 조회 API
- [ ] MaskingUtils 구현
- [ ] MyInfoResponse DTO 추가
- [ ] MemberFacade.getMyInfo 추가
- [ ] MemberV1Controller.getMyInfo 추가
- [ ] 내 정보 조회 API 테스트

### Phase 4: HTTP 테스트 파일
- [ ] `.http/auth/login.http` 생성
- [ ] `.http/member/me.http` 생성

---

## Part 4: 테스트 시나리오

### 4.1 로그인 API 테스트

| 시나리오 | 입력 | 기대 결과 |
|---------|------|----------|
| 정상 로그인 | 유효한 loginId, password | 200 OK + accessToken |
| 존재하지 않는 ID | 없는 loginId | 401 Unauthorized |
| 잘못된 비밀번호 | 유효한 loginId, 틀린 password | 401 Unauthorized |
| 빈 loginId | "" | 400 Bad Request |
| 빈 password | "" | 400 Bad Request |

### 4.2 내 정보 조회 API 테스트

| 시나리오 | 조건 | 기대 결과 |
|---------|------|----------|
| 정상 조회 | 유효한 토큰 | 200 OK + 마스킹된 정보 |
| 토큰 없음 | Authorization 헤더 없음 | 401 Unauthorized |
| 만료된 토큰 | 만료된 JWT | 401 TOKEN_EXPIRED |
| 잘못된 토큰 | 변조된 JWT | 401 INVALID_TOKEN |
| 존재하지 않는 회원 | 삭제된 회원의 토큰 | 404 Not Found |

### 4.3 마스킹 테스트

| 입력 | 기대 출력 |
|------|----------|
| 이름: `홍길동` | `홍*동` |
| 이름: `김철` | `김*` |
| 이름: `John Doe` | `J******e` |
| 이메일: `hong@example.com` | `ho***@example.com` |
| 이메일: `a@b.com` | `a***@b.com` |

---

## Part 5: 보안 고려사항

### 5.1 JWT Secret 관리
- 환경 변수로 관리 (`JWT_SECRET`)
- 최소 256비트 (32자 이상)
- 프로덕션에서는 절대 하드코딩 금지

### 5.2 비밀번호 검증
- BCrypt 해시 비교 사용 (기존 구현 활용)
- 타이밍 공격 방지

### 5.3 토큰 보안
- HTTPS 필수
- 토큰 만료 시간 적절히 설정
- Refresh Token은 이번 구현 범위 외 (추후 확장 가능)

---

## 구현 요청 프롬프트

아래 프롬프트를 사용하여 구현을 요청할 수 있습니다:

```
위의 요구사항 문서(docs/내정보조회-요구사항.md)를 기반으로
JWT 인증 시스템과 내 정보 조회 API를 구현해주세요.

구현 순서:
1. Phase 1: JWT 인프라 (의존성, 설정, 토큰 프로바이더, 필터)
2. Phase 2: 로그인 API (DTO, Service, Facade, Controller)
3. Phase 3: 내 정보 조회 API (마스킹 유틸, DTO, Facade 수정, Controller 수정)
4. Phase 4: HTTP 테스트 파일

TDD 방식으로 진행해주세요:
- 각 Phase마다 테스트 먼저 작성 (Red)
- 테스트 통과하는 최소 구현 (Green)
- 리팩토링 (Refactor)
```
