
# Part 2: 설계 결정 (How)

> 요구사항을 어떻게 구현할 것인가 (변경 가능)

---

## 1. 삭제 전략

**요구사항**: 삭제된 데이터는 조회에서 제외된다

| 선택지 | 결정 |
|--------|------|
| Hard Delete | ❌ |
| Soft Delete (deletedAt) | ✅ |

**이유**: 이력 보존, 연관 데이터 정합성

**바뀌면**: 모든 Repository 쿼리 조건 수정

---

## 2. status vs deletedAt 분리

**요구사항**: 운영자가 노출을 제어할 수 있다 + 삭제된 데이터는 제외된다

| 선택지 | 결정 |
|--------|------|
| status에 DELETED 포함 | ❌ |
| status와 deletedAt 분리 | ✅ |

**이유**: 비즈니스 상태와 삭제는 독립적인 개념

**바뀌면**: 상태 전이 로직, 조회 조건 전체 수정

---

## 3. 재고 동시성 전략

**요구사항**: 주문 시 재고는 정합성이 보장되어야 한다

| 선택지 | 결정 |
|--------|------|
| 비관적 락 (SELECT FOR UPDATE) | ❌ |
| 낙관적 락 (version) | △ 대안 |
| 조건부 UPDATE (`stock >= ?`) | ✅ |

**이유**: DB 레벨 원자성, 재시도 불필요

**바뀌면**: ProductRepository.decreaseStock() 쿼리 수정

---

## 4. 좋아요 수 집계 전략

**요구사항**: 좋아요 많은순 정렬이 가능해야 한다

| 선택지 | 결정 |
|--------|------|
| 매번 COUNT 쿼리 | ❌ |
| 상품 필드로 관리 (likeCount) | ✅ |
| 비동기 집계 (이벤트) | ❌ |

**이유**: 조회/정렬 성능

**바뀌면**: Like 등록/취소 트랜잭션 범위 변경, Redis 캐시 전환 가능

---

## 5. 주문 스냅샷 전략

**요구사항**: 주문 당시 상품 정보는 변경/삭제되어도 유지되어야 한다

| 선택지 | 결정 |
|--------|------|
| productId만 저장 (FK) | ❌ |
| OrderItem에 핵심 정보 복사 | ✅ |
| 전체 정보 스냅샷 | ❌ |

**스냅샷 범위**: productName, brandName, price, quantity

**바뀌면**: OrderItem 엔티티 필드 추가/제거

---

## 6. 브랜드 삭제 시 상품 처리

**요구사항**: 브랜드 삭제 시 해당 브랜드의 모든 상품도 삭제된다

| 선택지 | 결정 |
|--------|------|
| 동기 처리 (단일 트랜잭션) | ✅ (MVP) |
| 비동기 처리 (이벤트) | △ 대량 데이터 시 |

**가정**: 브랜드당 상품 수 100개 이하

**바뀌면**: 이벤트 발행, 청크 단위 처리로 전환

---

## 7. 트랜잭션 경계

### 좋아요 등록

```
┌─────────────────────────────┐
│ Like 존재 확인               │
│ Like INSERT                 │
│ Product.likeCount += 1      │
└─────────────────────────────┘
```

### 주문 생성

```
┌─────────────────────────────┐
│ 모든 상품 재고 검증           │
│ 모든 상품 재고 차감           │
│ Order 생성                  │
│ OrderItem 생성 (스냅샷)      │
└─────────────────────────────┘
```

**실패 시**: 전체 롤백 (All or Nothing)

### 주문 취소

```
┌─────────────────────────────┐
│ Order 상태 검증 (PENDING)    │
│ 모든 OrderItem 재고 복구     │
│ Order.status = CANCELLED    │
└─────────────────────────────┘
```

---

## 8. 설계 가정 (변경 시 영향 범위)

| 가정 | 현재 | 변경 시 영향 |
|------|------|-------------|
| 타임존 | KST (LocalDateTime) | 모든 DateTime → ZonedDateTime |
| 브랜드-상품 등록 간격 | 제한 없음 | Brand.registeredAt 추가, 검증 로직 |
| 상품 승인 | 즉시 노출 | Product.status에 PENDING_APPROVAL 추가 |
| 주문 상태 | 단순 (PENDING/COMPLETED/CANCELLED) | 결제/배송 연동 시 상태 확장 |
