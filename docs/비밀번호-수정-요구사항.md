# 비밀번호 수정 API 요구사항

## 개요
인증된 사용자가 현재 비밀번호를 확인한 뒤 새 비밀번호로 변경할 수 있는 API를 제공합니다.

---

## Part 1: 비밀번호 수정 API

### 1.1 Endpoint

```
PATCH /api/v1/members/me/password
Authorization: Bearer {accessToken}
```

### 1.2 Request Body

```json
{
  "currentPassword": "string",
  "newPassword": "string"
}
```

### 1.3 Response (성공 - 200 OK)

```json
{
  "meta": {
    "result": "SUCCESS",
    "errorCode": null,
    "message": null
  },
  "data": null
}
```

### 1.4 Response (실패)

#### 현재 비밀번호 불일치 (401 Unauthorized)
```json
{
  "meta": {
    "result": "FAIL",
    "errorCode": "UNAUTHORIZED",
    "message": "현재 비밀번호가 일치하지 않습니다."
  },
  "data": null
}
```

#### 비밀번호 규칙 위반 (400 Bad Request)
```json
{
  "meta": {
    "result": "FAIL",
    "errorCode": "Bad Request",
    "message": "비밀번호는 8~16자여야 합니다."
  },
  "data": null
}
```

#### 현재 비밀번호와 동일 (400 Bad Request)
```json
{
  "meta": {
    "result": "FAIL",
    "errorCode": "Bad Request",
    "message": "현재 비밀번호와 동일한 비밀번호는 사용할 수 없습니다."
  },
  "data": null
}
```

#### 인증 토큰 없음 (401 Unauthorized)
```json
{
  "meta": {
    "result": "FAIL",
    "errorCode": "UNAUTHORIZED",
    "message": "인증이 필요합니다."
  },
  "data": null
}
```

---

## Part 2: 비밀번호 검증 규칙

### 2.1 필수 규칙

| # | 규칙 | 검증 방법 |
|---|------|----------|
| 1 | 현재 비밀번호 일치 확인 | `BCryptPasswordEncoder.matches` |
| 2 | 새 비밀번호 8~16자 | 길이 검증 |
| 3 | 영문 대/소문자, 숫자, 특수문자만 허용 | Regex 검증 |
| 4 | 생년월일 포함 불가 (YYYYMMDD, YYMMDD, MMDD) | `PasswordValidator.containsBirthDate` |
| 5 | 현재 비밀번호와 동일한 비밀번호 사용 불가 | rawPassword 문자열 비교 |
| 6 | JWT 인증 필요 | `JwtAuthenticationFilter` |

### 2.2 추가 규칙

| # | 규칙 | 설명 | 예시 |
|---|------|------|------|
| A | 최소 2종류 문자 조합 필수 | 영문, 숫자, 특수문자 중 2종류 이상 | `aaaaaaaa` (X), `Passwo1!` (O) |
| B | 연속 동일문자 3개 이상 금지 | 같은 문자 연속 3회 이상 불가 | `Paaass1!` (X), `Paass1!x` (O) |
| C | 연속 순서문자 3개 이상 금지 | 오름/내림차순 연속 3회 이상 불가 | `Pabcss1!` (X), `Pa1ce2!x` (O) |
| D | 로그인 ID 포함 금지 | 비밀번호에 loginId 문자열 포함 불가 | loginId=`test` → `test1234!` (X) |

---

## Part 3: 구현 컴포넌트

### 3.1 레이어별 구조

```
support/util/
  └── PasswordValidator.kt          # 비밀번호 검증 유틸리티 (공통)

interfaces/api/member/
  ├── MemberV1Controller.kt          # + PATCH /me/password 추가
  ├── MemberV1ApiSpec.kt             # + changePassword 스펙 추가
  └── MemberV1Dto.kt                 # + ChangePasswordRequest 추가

application/member/
  └── MemberFacade.kt                # + changePassword 추가

domain/member/
  ├── MemberModel.kt                 # + changePassword 메서드 추가
  └── MemberService.kt               # + changePassword 메서드 추가
```

### 3.2 처리 흐름

```
Controller (PATCH /me/password)
  → JWT 인증 (JwtAuthenticationFilter에서 자동 처리)
  → Facade.changePassword(memberId, currentPassword, newPassword)
    → MemberService.findById(memberId) : 회원 조회
    → BCryptPasswordEncoder.matches(currentPassword, member.password) : 현재 비밀번호 확인
    → currentPassword == newPassword 검증 : 동일 비밀번호 방지
    → PasswordValidator.validatePassword(newPassword, member.birthDate, member.loginId) : 규칙 검증
    → BCryptPasswordEncoder.encode(newPassword) : 새 비밀번호 인코딩
    → MemberModel.changePassword(encodedPassword) : 도메인 모델 업데이트
    → MemberRepository.save(member) : 저장
```

### 3.3 PasswordValidator (공통 유틸리티)

회원가입(`SignUpRequest`)과 비밀번호 수정에서 동일한 비밀번호 검증 로직을 재사용합니다.

```kotlin
object PasswordValidator {
    fun validatePassword(password: String, birthDate: LocalDate, loginId: String? = null)
    fun containsBirthDate(password: String, birthDate: LocalDate): Boolean
}
```

**검증 순서:**
1. 길이 검증 (8~16자)
2. 허용 문자 검증 (영문 대소문자, 숫자, 특수문자)
3. 최소 2종류 문자 조합
4. 연속 동일문자 3개 이상
5. 연속 순서문자 3개 이상
6. 생년월일 포함 여부
7. 로그인 ID 포함 여부 (loginId가 null이 아닌 경우)

### 3.4 인증 경로

`JwtAuthenticationFilter`의 `AUTHENTICATED_PATHS`는 `path.startsWith(it)` 방식으로 동작하므로, 기존 `/api/v1/members/me`가 `/api/v1/members/me/password`를 자동으로 커버합니다. 별도 수정은 불필요합니다.

---

## Part 4: 구현 체크리스트

### Phase 1: 비밀번호 검증 로직 추출 (리팩터링)
- [x] `PasswordValidator` 유틸리티 클래스 생성
- [x] `containsBirthDate` 로직 이동
- [x] 추가 규칙 구현 (2종류 조합, 연속 동일문자, 연속 순서문자, loginId 포함)
- [x] `SignUpRequest.init` → `PasswordValidator.validatePassword()` 호출로 변경
- [x] `PasswordValidatorTest` 단위 테스트 (30개 케이스)

### Phase 2: 도메인 레이어
- [ ] `MemberModel.changePassword(newEncodedPassword)` 메서드 추가
- [ ] `MemberService.changePassword(id, newEncodedPassword)` 메서드 추가
- [ ] `MemberModelTest` - changePassword 테스트
- [ ] `MemberServiceTest` - changePassword 테스트

### Phase 3: Facade 레이어
- [ ] `MemberFacade.changePassword(memberId, currentPassword, newPassword)` 추가
- [ ] `MemberFacadeTest` - 비밀번호 변경 시나리오 테스트

### Phase 4: Interface 레이어 (Controller + DTO)
- [ ] `MemberV1Dto.ChangePasswordRequest` DTO 추가
- [ ] `MemberV1ApiSpec` - changePassword 스펙 추가
- [ ] `MemberV1Controller` - `PATCH /api/v1/members/me/password` 엔드포인트 추가
- [ ] `MemberV1ApiE2ETest` - 비밀번호 변경 E2E 테스트

### Phase 5: HTTP 테스트 파일
- [ ] `.http/member/change-password.http` 생성

---

## Part 5: 테스트 시나리오

### 5.1 PasswordValidator 단위 테스트

| 시나리오 | 입력 | 기대 결과 |
|---------|------|----------|
| 유효한 비밀번호 | `Password1!` | 예외 없음 |
| 8자 미만 | `Pass1!a` | BAD_REQUEST |
| 16자 초과 | 17자 이상 | BAD_REQUEST |
| 한글 포함 | `Password1!가` | BAD_REQUEST |
| 공백 포함 | `Pass word1!` | BAD_REQUEST |
| YYYYMMDD 포함 | `19900515A!` | BAD_REQUEST |
| YYMMDD 포함 | `A!900515bb` | BAD_REQUEST |
| MMDD 포함 | `Abc0515de!` | BAD_REQUEST |
| 영문만 | `abcdefgh` | BAD_REQUEST |
| 숫자만 | `12345678` | BAD_REQUEST |
| 특수문자만 | `!@#$%^&*` | BAD_REQUEST |
| 동일문자 3연속 | `Paaassw1!` | BAD_REQUEST |
| 순서문자 3연속 (오름) | `Pabcssw1!` | BAD_REQUEST |
| 순서문자 3연속 (내림) | `Pcbassw1!` | BAD_REQUEST |
| loginId 포함 | `test_user1!` | BAD_REQUEST |

### 5.2 도메인 레이어 테스트

| 시나리오 | 입력 | 기대 결과 |
|---------|------|----------|
| 비밀번호 변경 성공 | 새 인코딩된 비밀번호 | password 필드 변경됨 |
| 서비스 비밀번호 변경 | 존재하는 회원 ID + 새 비밀번호 | 저장 호출됨 |
| 존재하지 않는 회원 | 없는 ID | NOT_FOUND |

### 5.3 Facade 레이어 테스트

| 시나리오 | 조건 | 기대 결과 |
|---------|------|----------|
| 비밀번호 변경 성공 | 현재 비밀번호 일치 + 유효한 새 비밀번호 | 정상 처리 |
| 현재 비밀번호 불일치 | 틀린 현재 비밀번호 | UNAUTHORIZED |
| 동일 비밀번호 | 현재 = 새 비밀번호 | BAD_REQUEST |

### 5.4 E2E 테스트

| 시나리오 | 조건 | 기대 결과 |
|---------|------|----------|
| 비밀번호 변경 성공 | 유효한 토큰 + 올바른 요청 | 200 OK |
| 인증 없음 | Authorization 헤더 없음 | 401 UNAUTHORIZED |
| 현재 비밀번호 불일치 | 틀린 currentPassword | 401 UNAUTHORIZED |
| 동일 비밀번호 | currentPassword == newPassword | 400 BAD_REQUEST |
| 비밀번호 규칙 위반 | 짧은 newPassword | 400 BAD_REQUEST |

---

## Part 6: 보안 고려사항

### 6.1 비밀번호 안전성
- BCrypt 해시를 통한 비밀번호 저장 (평문 저장 금지)
- 비밀번호 비교 시 BCrypt.checkpw 사용 (타이밍 공격 방지)
- 비밀번호 변경 시 이전 비밀번호 재사용 방지

### 6.2 인증/인가
- JWT 토큰 필수 (JwtAuthenticationFilter 자동 처리)
- 본인만 자신의 비밀번호 변경 가능 (memberId from JWT)

### 6.3 입력 검증
- 모든 비밀번호 규칙을 서버 사이드에서 검증
- 에러 메시지에 민감 정보 노출 금지

---

## Part 7: 검증 명령어

```bash
# 전체 테스트
./gradlew :apps:commerce-api:test

# ktlint 검사
./gradlew :apps:commerce-api:ktlintCheck

# 빌드
./gradlew :apps:commerce-api:build
```

`.http/member/change-password.http`로 수동 API 테스트 가능.
