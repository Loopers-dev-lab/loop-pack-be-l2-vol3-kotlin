# DEC-004: 동시 주문 재고 제어 전략

| 항목 | 내용 |
|------|------|
| **상태** | OPEN |
| **관련 도메인** | Orders, Products |
| **관련 요구사항** | UC-O01 주문 요청 |

## 기능적 요구사항

동시에 같은 상품을 주문할 때 재고 정합성을 보장해야 한다.

## 미결정 사항

| 선택지 | 설명 | 장점 | 단점 |
|--------|------|------|------|
| **비관적 락 (Pessimistic Lock)** | DB SELECT FOR UPDATE로 Row 잠금 | 구현 간단, 강한 정합성 보장 | DB 커넥션 점유, 동시성 처리량 제한 |
| **낙관적 락 (Optimistic Lock)** | 버전 컬럼 기반 충돌 감지 | DB 잠금 없음, 충돌 적을 때 효율적 | 충돌 시 재시도 로직 필요, 충돌 빈번하면 비효율 |
| **분산 락 (Redis 등)** | Redis SETNX 등으로 분산 환경 잠금 | 멀티 인스턴스 환경 지원 | 인프라 의존성 추가, 락 만료 관리 필요 |
| **큐 기반 순차 처리** | 주문 요청을 큐에 넣고 순차 소비 | 완벽한 순서 보장 | 응답 지연, 아키텍처 복잡도 증가 |

## 진짜 필요한 것

재고가 **음수가 되지 않으면서**도, 동시 사용자 경험을 **과도하게 저하시키지 않는** 재고 제어 메커니즘.

핵심 질문:
- 현재 예상 동시 주문 규모는? (초당 몇 건)
- 단일 DB 인스턴스인가, 멀티 인스턴스인가?
- 재고 정합성 vs 응답 속도, 어디에 더 무게를 두는가?

## 변경 가능성

- 트래픽 규모에 따라 전략이 달라짐
- 초기에는 단순 락(비관적 락), 규모 확대 시 분산 락이나 큐로 전환
- 단계적 진화가 가능한 구조로 설계해야 전환 비용을 줄일 수 있음

## 참고

- 프로젝트 설계 시 고려사항: "재고 확인 → 재고 차감은 원자적으로 이루어져야 한다"
- 기술 스택에 Redis가 포함되어 있으므로 분산 락 인프라는 확보 가능
