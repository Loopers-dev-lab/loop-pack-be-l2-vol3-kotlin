# 요구사항 명세서

본 설계는 단일 애플리케이션, 단일 RDB 트랜잭션 환경을 전제로 한다.  
회원(User) 도메인은 1주차에 완성되었으며, 본 문서의 설계 범위에서 제외한다.  
단, 연관관계는 표현한다.

---

## 1. 도메인 별 시나리오

### 브랜드

| 관점 | 문제 |
|------|------|
| 사용자 | 상품이 어떤 브랜드인지 알고 싶다 |
| 비즈니스 | 브랜드별로 상품을 그룹화하고 관리해야 한다 |
| 시스템 | 브랜드 삭제 시 연관 상품 처리가 필요하다 |

### 상품

| 관점 | 문제 |
|------|------|
| 사용자 | 상품 정보를 보고 구매 결정을 내리고 싶다 |
| 비즈니스 | 상품 정보, 재고, 인기도를 관리해야 한다 |
| 시스템 | 동시 주문 시 재고 정합성을 보장해야 한다 |

### 좋아요

| 관점 | 문제 |
|------|------|
| 사용자 | 관심 상품을 저장하고 나중에 찾아보고 싶다 |
| 비즈니스 | 사용자 선호도 데이터를 수집하고 인기 상품을 파악해야 한다 |
| 시스템 | 중복 요청에도 안정적으로 동작해야 한다 |

### 주문

| 관점 | 문제 |
|------|------|
| 사용자 | 여러 상품을 한 번에 주문하고, 내역을 확인하고 싶다 |
| 비즈니스 | 주문 이력을 관리하고 재고 정합성을 유지해야 한다 |
| 시스템 | 주문 당시 상품 정보는 변경되어도 유지되어야 한다 |

---

## 2. 도메인 용어 정리

| 한글 | 영문 | 설명 |
|------|------|------|
| 브랜드 | Brand | 상품을 제공하는 입점 업체 |
| 상품 | Product | 판매되는 개별 아이템 |
| 재고 | Stock | 판매 가능한 상품 수량 |
| 좋아요 | Like | 회원이 관심 상품을 저장하는 행위 |
| 좋아요 수 | LikeCount | 상품에 대한 좋아요 집계 (비정규화 필드) |
| 주문 | Order | 회원이 상품을 구매하는 행위 |
| 주문 항목 | OrderItem | 주문에 포함된 개별 상품 정보 (스냅샷 포함) |
| 스냅샷 | Snapshot | 주문 시점의 상품 정보 사본 (이름, 가격) |
| 활성 | ACTIVE | 고객에게 노출되는 상태 |
| 비활성 | INACTIVE | 운영자가 숨긴 상태 |
| 논리 삭제 | Soft Delete | 데이터를 물리 삭제하지 않고 삭제 표시만 하는 방식 |

---

## 3. 기능 목록

### 브랜드

| 기능 | 액터 | 설명 |
|------|------|------|
| 브랜드 조회 | 고객 | 브랜드 정보를 조회한다 |
| 브랜드 등록 | 어드민 | 새 브랜드를 등록한다 |
| 브랜드 수정 | 어드민 | 브랜드 정보를 수정한다 |
| 브랜드 삭제 | 어드민 | 브랜드를 삭제한다 |

### 상품

| 기능 | 액터 | 설명 |
|------|------|------|
| 상품 목록 조회 | 고객 | 상품 목록을 조회한다 (정렬: 최신/가격/좋아요) |
| 상품 상세 조회 | 고객 | 상품 상세 정보를 조회한다 |
| 상품 등록 | 어드민 | 새 상품을 등록한다 |
| 상품 수정 | 어드민 | 상품 정보를 수정한다 |
| 상품 삭제 | 어드민 | 상품을 삭제한다 |

### 좋아요

| 기능 | 액터 | 설명 |
|------|------|------|
| 좋아요 등록 | 회원 | 상품에 좋아요를 누른다 |
| 좋아요 취소 | 회원 | 좋아요를 취소한다 |
| 좋아요 목록 조회 | 회원 | 내가 좋아요한 상품 목록을 조회한다 |

### 주문

| 기능 | 액터 | 설명 |
|------|------|------|
| 주문 생성 | 회원 | 상품을 주문한다 |
| 주문 목록 조회 | 회원 | 내 주문 목록을 조회한다 |
| 주문 상세 조회 | 회원 | 주문 상세를 조회한다 |
| 주문 취소 | 회원 | 주문을 취소한다 |
| 주문 조회 | 어드민 | 전체 주문을 조회한다 |

---

## 4. 정책 (비즈니스 규칙)

### 공통 — 삭제 정책

| 규칙 | 설명 |
|------|------|
| BR-C01 | 브랜드/상품 삭제는 논리 삭제(Soft Delete)로 처리한다 |
| BR-C02 | 삭제된 데이터는 고객 조회에서 제외된다 |
| BR-C03 | 삭제된 데이터도 어드민은 조회할 수 있다 |
| BR-C04 | 삭제된 상품은 주문 이력에 영향을 주지 않는다 (스냅샷으로 보존) |
| BR-C05 | 삭제된 상품의 좋아요는 유지된다 (취소 가능) |

### 브랜드

| 규칙 | 설명 |
|------|------|
| BR-B01 | 브랜드명은 중복될 수 없다 |
| BR-B02 | 브랜드 삭제 시 해당 브랜드의 모든 상품도 논리 삭제된다 (연쇄 Soft Delete) |
| BR-B03 | 삭제된 브랜드는 고객 조회에서 제외된다 |

### 상품

| 규칙 | 설명 |
|------|------|
| BR-P01 | 상품은 존재하는(삭제되지 않은) 브랜드에만 등록할 수 있다 |
| BR-P02 | 상품의 브랜드는 변경할 수 없다 |
| BR-P03 | 삭제된 상품은 고객 조회에서 제외된다 |
| BR-P04 | 재고가 0이어도 목록에는 노출된다 (구매만 차단) |
| BR-P05 | 좋아요 많은순 정렬이 가능해야 한다 |

### 좋아요

| 규칙 | 설명                                                                                                                                                   |
|------|------------------------------------------------------------------------------------------------------------------------------------------------------|
| BR-L01 | 한 사용자는 같은 상품에 1회만 좋아요할 수 있다                                                                                                                          |
| BR-L02 | 이미 좋아요한 상품에 다시 요청해도 에러가 아니다 (멱등성)                                                                                                                    |
| BR-L03 | 좋아요하지 않은 상품 취소 요청도 에러가 아니다 (멱등성)                                                                                                                     |
| BR-L04 | 삭제된 상품에는 좋아요할 수 없다                                                                                                                                   |
| BR-L05 | 좋아요 수는 현재 강한 일관성(strong consistency)으로 보장한다. <br/> 트랜잭션 내에서 좋아요 저장과 카운트 증감을 원자적으로 처리한다. <br/> 트래픽 증가 시 비동기 집계(eventual consistency)로 전환 가능한 구조를 전제한다 |

### 주문

| 규칙 | 설명 |
|------|------|
| BR-O01 | 주문 시 재고는 정합성이 보장되어야 한다 |
| BR-O02 | 재고가 부족하면 주문 전체가 실패한다 (부분 주문 없음) |
| BR-O03 | 주문 당시 상품 정보는 변경/삭제되어도 유지되어야 한다 (스냅샷) |
| BR-O04 | 삭제된 상품은 주문할 수 없다 |
| BR-O05 | 주문 취소는 PENDING 상태에서만 가능하다 |
| BR-O06 | 주문 취소 시 재고가 복구된다 |
| BR-O07 | 타인의 주문은 조회/취소할 수 없다 |

---

## 5. 상태 정의

### 브랜드/상품 상태

| 상태 | 설명 |
|------|------|
| ACTIVE | 고객에게 노출됨 |
| INACTIVE | 운영자가 숨김 (데이터 유지) |

### 주문 상태

| 상태 | 의미 | 설명 |
|------|------|------|
| PENDING | 결제 대기 | 주문이 생성되었으나 아직 결제가 완료되지 않은 상태. 이 상태에서만 무료 취소가 가능하다 |
| COMPLETED | 주문 확정 | 결제가 완료되어 주문이 확정된 상태. 배송 도입 시 상태 세분화 예정 |
| CANCELLED | 취소됨 | 사용자가 취소한 상태. 재고가 복구된다 |

```
현재:
  PENDING → COMPLETED (결제 없음, 즉시 전이)
          → CANCELLED (사용자 취소)

확장 시 (결제 도입):
  PENDING_PAYMENT → PAID → SHIPPING → COMPLETED
                                    → CANCEL_REQUESTED → CANCELLED → REFUNDED
```

현재는 결제 기능이 구현되지 않았으므로, 주문 생성 직후 PENDING → COMPLETED로 즉시 전이된다.
상태 전이 규칙은 도메인이 보호하고, 전이 시점은 ApplicationService가 결정한다.
확장 시 상태 추가만으로 대응 가능한 구조를 전제한다.

### 삭제 상태

- 논리 삭제: `deletedAt` 필드로 관리
- 삭제된 데이터는 고객 조회에서 제외, 어드민은 조회 가능
- 삭제 후 복구는 현재 지원하지 않는다

---

## 6. 유스케이스 흐름

### 브랜드 등록

**Main Flow**
1. 어드민은 브랜드 정보(이름, 설명, 로고)를 입력하여 등록을 요청한다
2. 시스템은 브랜드명 중복 여부를 확인한다
3. 시스템은 브랜드를 생성한다 (ACTIVE 상태)
4. 시스템은 브랜드를 저장한다
5. 어드민에게 등록 성공을 응답한다

**Alternate Flow**
- A1: 브랜드명이 이미 존재함 → 409 CONFLICT (BR-B01)
- A2: 동시 등록으로 UNIQUE 제약 위반 → 409 CONFLICT

### 브랜드 삭제

**Main Flow**
1. 어드민은 브랜드 삭제를 요청한다
2. 시스템은 브랜드를 조회한다
3. 시스템은 브랜드를 논리 삭제한다 (Soft Delete)
4. 시스템은 해당 브랜드의 모든 상품을 논리 삭제한다 (연쇄 Soft Delete, BR-B02)
5. 어드민에게 삭제 성공을 응답한다

**Alternate Flow**
- A1: 브랜드가 존재하지 않음 → 404
- A2: 이미 삭제된 브랜드 → 변경 없이 성공 반환 (멱등)

**Exception Flow**
- E1: 연쇄 Soft Delete 중 예외 → 전체 롤백 (브랜드 삭제 포함)

### 주문 생성

**Main Flow**
1. 회원은 상품과 수량을 선택하여 주문을 요청한다
2. 시스템은 각 상품의 존재 여부를 확인한다
3. 시스템은 각 상품의 재고가 충분한지 검증한다
4. 시스템은 각 상품의 재고를 차감한다
5. 시스템은 주문 시점의 상품 정보로 스냅샷을 생성한다
6. 시스템은 주문(PENDING)을 저장한다
7. 현재는 결제 미구현이므로 즉시 COMPLETED로 전이한다
8. 회원에게 주문 생성 성공을 응답한다

**Alternate Flow**
- A1: 상품이 존재하지 않거나 삭제됨 → 즉시 실패 (BR-O04)
- A2: 일부 상품 재고 부족 → 주문 전체 실패, 차감 없음 (BR-O02)
- A3: 동시 주문으로 재고 차감 실패 → 주문 전체 실패, 롤백

**Exception Flow**
- E1: 트랜잭션 중 예외 발생 → 전체 롤백 (재고 차감 포함)

### 주문 취소

**Main Flow**
1. 회원은 주문 취소를 요청한다
2. 시스템은 주문을 조회한다
3. 시스템은 본인 주문인지 검증한다 (BR-O07)
4. 시스템은 취소 가능 상태(PENDING)인지 검증한다 (BR-O05)
5. 시스템은 주문 상태를 CANCELLED로 변경한다
6. 시스템은 각 주문 항목의 재고를 복구한다 (BR-O06)
7. 회원에게 취소 성공을 응답한다

**Alternate Flow**
- A1: 주문이 존재하지 않음 → 404
- A2: 본인 주문이 아님 → 403
- A3: PENDING이 아닌 상태 → 400

**Exception Flow**
- E1: 재고 복구 중 예외 → 전체 롤백 (상태 변경 포함)

### 좋아요 등록

**Main Flow**
1. 회원은 상품에 좋아요를 요청한다
2. 시스템은 상품 존재 여부를 확인한다
3. 시스템은 좋아요 저장을 시도한다 (중복 무시)
4. 신규 좋아요인 경우, 시스템은 상품의 좋아요 수를 증가시킨다
5. 회원에게 성공을 응답한다

**Alternate Flow**
- A1: 상품이 존재하지 않거나 삭제됨 → 404 (BR-L04)
- A2: 이미 좋아요한 상품 → 변경 없이 성공 반환 (BR-L02, 멱등)

### 좋아요 취소

**Main Flow**
1. 회원은 좋아요 취소를 요청한다
2. 시스템은 좋아요 삭제를 시도한다
3. 실제 삭제된 경우, 시스템은 상품의 좋아요 수를 감소시킨다 (음수 방지)
4. 회원에게 성공을 응답한다

**Alternate Flow**
- A1: 좋아요하지 않은 상태 → 변경 없이 성공 반환 (BR-L03, 멱등)

---

## 7. 예외 케이스

| 상황 | 응답 | 관련 정책 |
|------|------|----------|
| 존재하지 않는 브랜드/상품 조회 | 404 NOT_FOUND | - |
| 삭제된 브랜드/상품 고객 조회 | 404 NOT_FOUND | BR-C02 |
| 중복 브랜드명 등록 | 409 CONFLICT | BR-B01 |
| 삭제된 브랜드에 상품 등록 | 400 BAD_REQUEST | BR-P01 |
| 삭제된 상품에 좋아요 | 404 NOT_FOUND | BR-L04 |
| 재고 부족 | 409 CONFLICT (부족한 상품 정보 포함) | BR-O01, BR-O02 |
| 삭제된 상품 주문 | 400 BAD_REQUEST | BR-O04 |
| PENDING이 아닌 주문 취소 | 400 BAD_REQUEST | BR-O05 |
| 타인의 주문 조회/취소 | 403 FORBIDDEN | BR-O07 |

---

## 8. 미결정 사항

| 항목 | 질문 | 현재 가정 |
|------|------|----------|
| 등록 간격 | 브랜드 등록 후 N일 후 상품 등록? | 제한 없음 |
| 승인 프로세스 | superAdmin 승인 후 노출? | 즉시 노출 |
| 타임존 | 글로벌 서비스? | KST 단일 |
| 삭제 복구 | 삭제된 브랜드/상품 복구 가능? | 현재 미지원 |
| 주문 상품 수 제한 | 한 번에 주문 가능한 최대 상품 수? | 미정 (권장 20개) |

---

## 9. 확장 고려 사항

> 현재 범위에 포함하지 않되, 설계가 막지 않아야 하는 확장 포인트  
> 
> "기술 선택은 늦추되, 기술을 수용할 경계는 만든다."

### 행동 로그 도메인

현재 좋아요/주문은 기능 단위로 설계되어 있다.  
감성 커머스로 확장 시, 사용자 행동(VIEW, LIKE, ORDER, CLICK)을 별도 도메인으로 분리하여  
랭킹/추천 시스템의 입력 데이터로 활용할 수 있다.  

- **현재 영향**: 없음. 현재 구조에서 이벤트 발행 포인트만 추가하면 된다
- **경계**: 행동 로그는 핵심 트랜잭션 밖에서 비동기로 처리되어야 한다

### 집계 전략 전환

현재 좋아요 수(BR-L05)는 강한 일관성으로 처리한다.
트래픽 증가 시 쓰기 경합이 병목이 될 수 있으며, 이때 비동기 집계로 전환할 수 있다.

- **현재 구조**: 트랜잭션 내 원자적 카운트 증감
- **전환 시**: 좋아요 이벤트 발행 → 비동기 집계 → 상품 카운트 반영 (eventual consistency)
- **경계**: 좋아요 수를 상품 필드로 비정규화한 현재 구조는 두 전략 모두 수용 가능하다

### 주문 생성 책임 경계와 결제 분리

주문 생성은 "결제 요청 가능한 주문을 만드는 것"까지 책임진다.
결제 승인/실패는 별도 유스케이스로 분리한다.

- **현재 구조**: 주문 생성(재고 차감 + 스냅샷 + 저장) → 즉시 COMPLETED 전이. 결제 없으므로 ApplicationService가 `complete()`를 직접 호출한다
- **확장 시**: 주문 생성은 PENDING까지만 책임. 결제 성공 시 별도 유스케이스(ConfirmPaymentUseCase)에서 `complete()` 호출
- **경계**: 상태 전이 규칙은 도메인이 보호한다. "언제 전이할 것인가"는 ApplicationService가 결정한다. 도메인 코드(`complete()` 검증 규칙)는 변경 없이 확장된다

### 주문 상태 확장

현재 주문 상태는 3개(PENDING, COMPLETED, CANCELLED)로 단순하다.
결제/배송 도입 시 상태가 확장되며, 이때 상태 전이를 도메인 레벨에서 관리하는 구조가 필요하다.

- **현재 구조**: 도메인 객체가 상태 전이 규칙을 검증 (ex. PENDING에서만 취소 가능)
- **확장 시**: 상태 전이 정책을 추가하는 것만으로 새로운 흐름 지원 가능
- **경계**: 상태 전이 규칙이 도메인 외부(서비스, 컨트롤러)에 흩어지지 않아야 한다

### 브랜드 콘텐츠 확장

현재 브랜드는 이름 중심의 단순 엔티티다.
감성 커머스에서 브랜드는 스토리/세계관을 가진 콘텐츠가 될 수 있다.

- **현재 구조**: 브랜드 ↔ 상품 1:N 관계
- **확장 시**: 브랜드 소개, 이미지, 스토리 등 콘텐츠 필드 추가
- **경계**: 브랜드 삭제가 논리 삭제(BR-B02)이므로, 콘텐츠 확장 시에도 데이터가 보존된다

---

## 10. API 엔드포인트

### 고객 API (`/api/v1`)

| Method | URI | 인증 |
|--------|-----|:----:|
| GET | `/brands/{id}` | X |
| GET | `/products` | X |
| GET | `/products/{id}` | X |
| POST | `/products/{id}/likes` | O |
| DELETE | `/products/{id}/likes` | O |
| GET | `/me/likes` | O |
| POST | `/orders` | O |
| GET | `/orders` | O |
| GET | `/orders/{id}` | O |
| DELETE | `/orders/{id}` | O |

### 어드민 API (`/api-admin/v1`)

| Method | URI |
|--------|-----|
| GET/POST | `/brands` |
| GET/PUT/DELETE | `/brands/{id}` |
| GET/POST | `/products` |
| GET/PUT/DELETE | `/products/{id}` |
| GET | `/orders`, `/orders/{id}` |
